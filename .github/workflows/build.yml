name: Build Desktop Apps

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Create icon
        run: |
          python -c "from PIL import Image; img = Image.open('assets/icon.png'); img.save('assets/icon.ico', format='ICO', sizes=[(256,256), (128,128), (64,64), (48,48), (32,32), (16,16)])"

      - name: Build executable
        run: pyinstaller tts_converter.spec --clean

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: TTS-Converter-Windows
          path: dist/TTS Converter.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install py2app

      - name: Create icon
        run: |
          mkdir -p assets/icon.iconset
          sips -z 16 16 assets/icon.png --out assets/icon.iconset/icon_16x16.png
          sips -z 32 32 assets/icon.png --out assets/icon.iconset/icon_16x16@2x.png
          sips -z 32 32 assets/icon.png --out assets/icon.iconset/icon_32x32.png
          sips -z 64 64 assets/icon.png --out assets/icon.iconset/icon_32x32@2x.png
          sips -z 128 128 assets/icon.png --out assets/icon.iconset/icon_128x128.png
          sips -z 256 256 assets/icon.png --out assets/icon.iconset/icon_128x128@2x.png
          sips -z 256 256 assets/icon.png --out assets/icon.iconset/icon_256x256.png
          sips -z 512 512 assets/icon.png --out assets/icon.iconset/icon_256x256@2x.png
          sips -z 512 512 assets/icon.png --out assets/icon.iconset/icon_512x512.png
          sips -z 1024 1024 assets/icon.png --out assets/icon.iconset/icon_512x512@2x.png
          iconutil -c icns assets/icon.iconset -o assets/icon.icns
          rm -rf assets/icon.iconset

      - name: Build app
        run: python setup_mac.py py2app

      - name: Create ZIP
        run: |
          cd dist
          zip -r "TTS Converter.app.zip" "TTS Converter.app"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: TTS-Converter-macOS
          path: dist/TTS Converter.app.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        run: pyinstaller tts_converter.spec --clean

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: TTS-Converter-Linux
          path: dist/TTS Converter
